<!doctype html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Registro de Estudiantes ¬∑ Asistencia</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- QRCode JS (robusto) -->
  <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>

  <style>
    /* Modal QR emergente */
    #qrModal {
      display: none;
      position: fixed;
      inset: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #qrModal.active { display: flex; }
    .qr-modal-content {
      background: var(--card, #111827);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.4);
      text-align: center;
      position: relative;
    }
    .qr-modal-content h3 { margin-bottom: 12px; color: var(--text, #e5e7eb); }
    .qr-large { width: 300px; height: 300px; margin: auto; }
    .close-modal {
      position: absolute; top: 10px; right: 10px;
      background: transparent; border: none; color: var(--text, #e5e7eb);
      font-size: 22px; cursor: pointer;
    }
    .close-modal:hover { color: #22d3ee; }
  </style>
</head>
<body>
  <header class="topbar glass">
    <div class="brand">
      <div class="logo">üéì</div>
      <h1>Registro de Estudiantes</h1>
    </div>
    <nav class="tabs" role="tablist" aria-label="Navegaci√≥n">
      <button class="tab active" role="tab" aria-selected="true" data-target="#tab-registro">Primera Ventana</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#tab-asistencia">Segunda Ventana</button>
      <button class="tab" role="tab" aria-selected="false" data-target="#tab-reportes">Tercera Ventana</button>
    </nav>
    <div class="controls">
      <button id="btnDensity" class="chip" title="Alternar densidad">Densidad</button>
      <button id="btnTheme" class="chip" title="Cambiar tema">Tema</button>
    </div>
  </header>

  <main class="container">
    <!-- PRIMERA VENTANA -->
    <section id="tab-registro" class="tab-panel active">
      <div class="card grid-2">
        <div>
          <h3 class="card-title">Nuevo / Editar estudiante</h3>
          <label>Nombre</label>
          <input id="nombre" type="text" placeholder="Ej. Ana L√≥pez" />
          <div class="inline"><button id="btnRellenarNombre" class="muted">Rellenar con Datos</button></div>

          <label>Carnet</label>
          <input id="carnet" type="text" placeholder="Ej. 20241234" />
          <div class="inline"><button id="btnRellenarCarnet" class="muted">Rellenar con Datos</button></div>

          <div class="actions">
            <button id="btnGuardar" class="primary">Guardar</button>
            <button id="btnActualizar" class="warning">Actualizaci√≥n de Datos</button>
            <button id="btnLimpiar" class="muted">Limpiar</button>
          </div>

          <!-- Bloque QR -->
          <div id="qrPanel" class="card subtle" style="margin-top:16px;text-align:center">
            <h4 class="card-title">QR a la Segunda Ventana</h4>
            <div id="qrcode" style="width:180px;height:180px;margin:auto;"></div>
            <small class="muted">üì± Escan√©alo con tu tel√©fono para abrir la asistencia.</small>
            <div style="margin-top:8px;">
              <!-- Enlace con HASH para m√°xima compatibilidad -->
              <a href="https://asistencia-rho.vercel.app/#asistencia" target="_blank" class="primary" style="text-decoration:none;color:#22d3ee;font-weight:bold">üîó Abrir Asistencia</a>
            </div>
            <div style="margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
              <button id="btnQrGrande" class="secondary">üîç Ver QR en grande</button>
              <button id="btnCopiarQR" class="muted">üìã Copiar enlace del QR</button>
            </div>
          </div>
        </div>

        <div>
          <h3 class="card-title">Estudiantes (clic para seleccionar)</h3>
          <input id="buscar" class="search" placeholder="Buscar por nombre o carnet..." />
          <div class="table-wrap">
            <table id="tablaEstudiantes" class="table">
              <thead><tr><th>Nombre</th><th>Carnet</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <small class="muted">Tip: Selecciona un registro para editarlo y luego usa ‚ÄúActualizaci√≥n de Datos‚Äù.</small>
        </div>
      </div>
    </section>

    <!-- SEGUNDA VENTANA -->
    <section id="tab-asistencia" class="tab-panel">
      <div class="card">
        <div class="row">
          <div><h3 class="card-title">Asistencia del d√≠a</h3><input id="fechaAsistencia" type="date" /></div>
          <div class="right">
            <button id="btnGuardarAsistencia" class="primary">Guardar Asistencia</button>
            <button id="btnMarcarTodos" class="secondary">Marcar todos</button>
            <button id="btnDesmarcarTodos" class="muted">Desmarcar</button>
          </div>
        </div>
        <div class="table-wrap">
          <table id="tablaAsistencia" class="table">
            <thead><tr><th style="width:110px">Presente</th><th>Nombre</th><th>Carnet</th><th>Asistencia</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <small class="muted">Tabla con todos los alumnos para marcar asistencia por fecha.</small>
      </div>
    </section>

    <!-- TERCERA VENTANA -->
    <section id="tab-reportes" class="tab-panel">
      <div class="card">
        <h3 class="card-title">Reportes & Penalizaciones</h3>
        <div class="grid-3">
          <div><label>Alumno</label><select id="selectAlumno"></select></div>
          <div><label>Desde</label><input id="desde" type="date" /></div>
          <div><label>Hasta</label><input id="hasta" type="date" /></div>
        </div>
        <div class="actions">
          <button id="btnCalcular" class="primary">Calcular</button>
          <button id="btnCSV" class="secondary">Descargar CSV</button>
          <button id="btnPDF" class="secondary">Descargar PDF</button>
        </div>
        <div class="stats">
          <div class="stat"><span id="statPresentes">0</span><label>Presentes</label></div>
          <div class="stat danger"><span id="statFaltas">0</span><label>Faltas</label></div>
          <div class="stat"><span id="statTotal">0</span><label>Total sesiones</label></div>
          <div class="stat badge"><span id="statPenaliza">No</span><label>Penalizaci√≥n (&gt;2 faltas)</label></div>
        </div>
        <div class="table-wrap">
          <table id="tablaReporte" class="table">
            <thead><tr><th>Fecha</th><th>Estado</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <div id="toaster" aria-live="polite" aria-atomic="true"></div>

  <!-- Modal QR -->
  <div id="qrModal">
    <div class="qr-modal-content">
      <button class="close-modal" id="closeModal">‚úñ</button>
      <h3>QR de Asistencia</h3>
      <div id="qrGrande" class="qr-large"></div>
    </div>
  </div>

  <!-- L√≥gica general + QR + Modal -->
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // Tabs
    document.querySelectorAll(".tab").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
        btn.classList.add("active");
        document.querySelector(btn.getAttribute("data-target")).classList.add("active");
        window.scrollTo({top:0, behavior:'smooth'});
      });
    });

    // Tema
    const root = document.documentElement;
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme) root.setAttribute("data-theme", savedTheme);
    document.getElementById("btnTheme")?.addEventListener("click", () => {
      const next = root.getAttribute("data-theme") === "dark" ? "light" : "dark";
      root.setAttribute("data-theme", next);
      localStorage.setItem("theme", next);
    });

    // Densidad
    const savedDensity = localStorage.getItem("density");
    if (savedDensity === "compact") document.body.classList.add("compact");
    document.getElementById("btnDensity")?.addEventListener("click", () => {
      document.body.classList.toggle("compact");
      localStorage.setItem("density",
        document.body.classList.contains("compact") ? "compact" : "comfortable");
    });

    // ====== QR ======
    const qrUrl = "https://asistencia-rho.vercel.app/#asistencia";
    const qrEl = document.getElementById("qrcode");
    const qrGrandeEl = document.getElementById("qrGrande");

    // Generar QR peque√±o (con delay para asegurar DOM listo)
    setTimeout(() => {
      if (typeof QRCode !== "undefined" && qrEl) {
        qrEl.innerHTML = "";
        new QRCode(qrEl, {
          text: qrUrl,
          width: 180,
          height: 180,
          correctLevel: QRCode.CorrectLevel.H
        });
      } else {
        console.warn("‚ö†Ô∏è QRCode.js no carg√≥ correctamente");
      }
    }, 500);

    // Bot√≥n Ver QR en grande (modal)
    const modal = document.getElementById("qrModal");
    document.getElementById("btnQrGrande")?.addEventListener("click", () => {
      modal.classList.add("active");
      qrGrandeEl.innerHTML = "";
      new QRCode(qrGrandeEl, {
        text: qrUrl,
        width: 300,
        height: 300,
        correctLevel: QRCode.CorrectLevel.H
      });
    });
    document.getElementById("closeModal")?.addEventListener("click", () => modal.classList.remove("active"));
    modal.addEventListener("click", e => { if (e.target === modal) modal.classList.remove("active"); });

    // Bot√≥n Copiar enlace del QR
    document.getElementById("btnCopiarQR")?.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(qrUrl);
        alert("Enlace copiado:\n" + qrUrl);
      } catch {
        alert("No se pudo copiar. Copia manual:\n" + qrUrl);
      }
    });

    // ====== Activar asistencia con query o hash ======
    function activarAsistencia() {
      document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
      document.getElementById("tab-asistencia")?.classList.add("active");
      document.querySelectorAll(".tabs .tab").forEach(b => {
        b.classList.remove("active");
        b.setAttribute("aria-selected", "false");
      });
      const btn = document.querySelector('.tabs .tab[data-target="#tab-asistencia"]');
      if (btn) {
        btn.classList.add("active");
        btn.setAttribute("aria-selected", "true");
      }
    }
    const params = new URLSearchParams(window.location.search);
    if (params.get("go") === "asistencia" || window.location.hash === "#asistencia") {
      activarAsistencia();
    }
  });
  </script>

  <!-- app.js al final: base de datos/tablas -->
  <script type="module" src="app.js"></script>
</body>
</html>

